对以下论文执行完整的深度分析流程：$ARGUMENTS

---

# Skill: 论文深度分析与双版本报告生成

## 概述

给定一个 arxiv 链接，自动完成：下载论文 → 搜索开源代码 → 生成两种 PDF 报告：
1. **逐行翻译版** (`*_dual.pdf`)：左页原文 PDF，右页逐句中文翻译 + 行内批注
2. **精炼版** (`*_summary.pdf`)：单页 PDF，结构化深度分析 + 代码解读

## 输入

从 `$ARGUMENTS` 中解析：
- `paper_url`: arxiv 链接（如 https://arxiv.org/abs/2601.16163）
- `paper_name`: 从 arxiv URL 中自动推断（取 arxiv ID 中的数字部分，如 `2601.16163` → `2601_16163`；若论文标题可识别，优先用简短英文名如 `cosmos_policy`）

工作目录为当前目录，所有产出放在当前目录下。

## 目录结构

```
./
├── papers/              # 原始 PDF
│   └── {name}.pdf
├── extracted/           # PDF 逐页文本提取（JSON）
│   └── {name}_pages.json
├── translations/        # 逐页翻译 markdown
│   ├── {name}_p1_5.md
│   ├── {name}_p6_10.md
│   └── ...
├── {name}_annotated.md  # 精炼版 markdown 源文件
└── output/              # 最终产出
    ├── {name}_dual.pdf     # 逐行翻译版
    └── {name}_summary.pdf  # 精炼版
```

---

## 工具链依赖

首次使用需安装（后续复用无需重复）：

```bash
bash setup.sh
```

核心组件：
| 工具 | 用途 |
|------|------|
| PyMuPDF (fitz) | PDF 文本提取、双页合并 |
| markdown | Markdown → HTML 转换 |
| Playwright + Chromium | HTML+KaTeX → PDF 渲染（公式、表格、排版）|
| KaTeX CDN | LaTeX 数学公式渲染（行内 `$...$` + 块级 `$$...$$`）|

---

## Phase 1: 资料收集

### 1.1 下载论文 PDF

```bash
mkdir -p papers extracted translations output
curl -L "https://arxiv.org/pdf/{arxiv_id}" -o papers/{name}.pdf
ls -la papers/{name}.pdf  # 确认 > 100KB
```

### 1.2 搜索开源代码

```
WebSearch "{paper_name} github code"
WebSearch "{paper_name} official implementation"
```

判断标准：
- 论文中明确提到的 GitHub 链接 → 优先
- 作者个人/机构 GitHub 上的同名仓库 → 次优
- 第三方复现 → 标注为非官方

```bash
git clone https://github.com/{org}/{repo}.git ../{repo_name}/
# HTTPS 超时时切换 SSH：
git clone git@github.com:{org}/{repo}.git ../{repo_name}/
```

### 1.3 代码结构探索

用 Explore agent 扫描仓库，记录：
- 核心模型定义文件（`model/`, `models/`, `src/`）
- 训练入口（`train.py`, `scripts/train.sh`）
- 配置文件（`config/`, `*.yaml`）
- 数据处理（`datasets/`, `data/`）
- 推理/评估（`eval/`, `inference/`）

---

## Phase 2: 精炼版报告（`*_annotated.md`）

### 2.1 文档结构模板

```markdown
# {中文标题}: {英文原标题}

## 全文翻译与深度批注

> 原文: "{English Title}"
> 作者: {作者列表}
> 机构: {机构}
> arxiv: {arxiv_id}
> 代码: {github_url 或 "未开源"}

---

## 前言：论文地位与贡献

> **【批注：为什么这篇论文重要？】**
>
> {历史脉络：列出 3-5 篇前序工作，用箭头串联发展线}
> {核心创新：一句话概括本文最关键的贡献}

---

## 作者与机构背景

### 核心作者

**{第一作者}** (第一作者)
- {职位、学校/公司}
- {导师（如适用）}

**{通讯/资深作者}**
- {职位}
- **重要贡献**: {代表作 2-3 篇}

> **【批注：作者阵容分析】**
>
> {分析团队构成的优势，如产学研结合、跨领域互补等}

---

## 正文翻译与批注

### 摘要
{精炼翻译，保留所有关键数字}
> **【批注】** {核心创新点的直觉解释}

### 1. 引言
{翻译核心论点，可适当精简}
> **【批注】** {现有方法的问题 → 本文的洞察}

### 2. 相关工作
{按范式分类总结，不需逐句翻译}
> **【批注】** {各范式优劣对比表}

### 3. 方法（重点，逐小节详细翻译）
{每个子节包含：}
  - 准确翻译
  - 公式用 LaTeX（$...$, $$...$$）
  - 公式后附直觉解释
  - 代码引用（如有开源）
  > **【批注】** {为什么这样设计、与其他方法的对比}

### 4. 实验
  - 实验设置（基准、基线、指标）
  - 主要结果（用 markdown 表格）
  - 消融实验
  > **【批注】** {关键发现、数据效率对比、局限性}

### 5. 讨论与结论
{翻译 + 局限性分析}
> **【批注】** {未来方向、对领域的影响}

---

## 附录要点
{选择性翻译重要的实现细节（超参数、训练配置等）}

---

## 开源代码分析（如有）

### 仓库概览
- 仓库: {github_url}
- 语言: Python, {框架}
- 核心文件: {列出 3-5 个关键文件}

### 核心实现解读
{对 3-5 个关键模块的代码分析，每个包含：}
- 文件路径和函数名
- 关键代码片段（不超过 15 行）
- 与论文的对应关系
- 实现细节批注

---

## 总结：实践建议
> **【批注】** {复现建议、可借鉴的设计、潜在改进方向}
```

### 2.2 批注规范

**格式：**
```markdown
> **【批注：{标题}】**
>
> {内容}
```

**批注类型（5 种）：**

| 类型 | 说明 | 示例场景 |
|------|------|---------|
| 术语解释型 | 解释专业术语，给出直觉理解 | "时空先验"、"潜在帧注入" |
| 对比分析型 | 与其他方法对比优劣 | VLA vs 视频模型的预训练差异 |
| 代码引用型 | 指向开源代码的具体实现 | "在 `model.py` 的 `forward()` 中实现" |
| 设计动机型 | 解释"为什么"而非"是什么" | 为什么用 best-of-N 而非树搜索 |
| 实践建议型 | 复现/借鉴的具体建议 | 推荐的超参数、训练技巧 |

**批注密度：**
- 摘要: 1-2 个
- 引言: 每个核心论点 1 个
- 方法: 每个子节 2-3 个（最密集）
- 实验: 每个结果表 1 个
- 讨论: 1-2 个总结性

### 2.3 代码分析要求

如果找到开源代码，需要：

1. 用 Explore agent 扫描仓库全貌
2. 重点分析 3-5 个核心模块：
   - 模型架构定义
   - 损失函数
   - 数据预处理 pipeline
   - 训练循环的关键逻辑
   - 推理/部署流程
3. 每个模块给出：文件路径、关键函数、代码片段（≤15 行）、与论文的对应关系
4. 追加到 `*_annotated.md` 末尾的 `## 开源代码分析` 章节

---

## Phase 3: 逐行翻译版（`translations/` → `*_dual.pdf`）

### 3.1 PDF 文本提取

```bash
python3 extract_pages.py . {name}
```

### 3.2 逐页翻译

**分批策略：** 每批 3-5 页，避免上下文溢出。

**翻译文件格式：** `translations/{name}_p{start}_{end}.md`

```markdown
<!-- PAGE 1 -->

# 论文标题的中文翻译

作者列表...

> **【批注：论文地位与贡献】**
>
> {历史脉络、核心创新、作者阵容分析}
> {这部分是精炼版中"前言"和"作者背景"的浓缩版}

**摘要**

{逐句翻译，保留所有技术术语的英文原文（括号标注）}

> **【批注】** {关键概念解释}

<!-- PAGE 2 -->

{继续逐句翻译...}
```

**翻译要求：**

1. **逐句忠实翻译**，不重组、不省略、不总结
2. 关键术语首次出现时标注英文原文：`潜在帧注入（latent frame injection）`
3. 公式保留原始 LaTeX：行内 `$x_0$`，块级 `$$\mathcal{L} = ...$$`
4. 图表描述翻译：`**图1：** {翻译图注}`
5. 每页用 `<!-- PAGE N -->` 标记，确保与原文 PDF 页码对齐
6. 批注穿插在翻译中，用 blockquote 格式
7. **第 1 页必须包含**：论文定位批注 + 作者阵容分析批注（从精炼版浓缩）

**并行执行：** 可同时启动多个 agent 翻译不同页码范围，最后合并。

### 3.3 公式处理（关键）

翻译文件中的公式会经过以下渲染链：

```
Markdown 源文件
  → protect_math(): 提取 $...$ 和 $$...$$ 为占位符
  → markdown.markdown(): 转 HTML（不破坏公式）
  → restore_math(): 还原公式
  → KaTeX auto-render: 浏览器端渲染为真正的数学排版
  → Playwright: 输出 PDF
```

**注意事项：**
- `markdown` 库会把公式中的 `_` 转为 `<em>`，必须先保护
- 块级公式 `$$...$$` 前后需要空行，否则可能被包裹在 `<p>` 中
- KaTeX 不支持所有 LaTeX 命令，常见兼容命令参考：https://katex.org/docs/supported

---

## Phase 4: PDF 生成

### 4.1 生成命令

```bash
python3 generate_pdf.py . dual {paper_name}
python3 generate_pdf.py . summary {paper_name}
python3 generate_pdf.py . all {paper_name}
```

### 4.2 逐行翻译版的页面对齐逻辑

```
对于原文的每一页 N：
  1. 从 translations/ 中提取 <!-- PAGE N --> 对应的内容
  2. 单独渲染为 PDF（可能 1 页或多页）
  3. 合并：
     - 第 1 个 spread：左=原文第 N 页，右=翻译第 1 页
     - 如果翻译溢出：后续 spread 左=重复原文第 N 页，右=翻译后续页
  4. 无翻译的页面：左=原文，右=空白
```

---

## Phase 5: 质量检查

### 精炼版检查清单

- [ ] 所有章节都已覆盖（摘要→引言→方法→实验→讨论）
- [ ] 方法部分逐小节详细翻译
- [ ] 核心公式都有直觉解释
- [ ] 关键数字（成功率、参数量等）准确
- [ ] 代码引用指向正确的文件和函数（如有开源）
- [ ] 批注覆盖所有关键设计决策
- [ ] 前言准确定位了论文的历史地位
- [ ] 作者背景信息准确
- [ ] 末尾有实践建议

### 逐行翻译版检查清单

- [ ] 每页都有 `<!-- PAGE N -->` 标记
- [ ] 页码与原文 PDF 一一对应
- [ ] 第 1 页包含论文定位 + 作者分析批注
- [ ] 公式使用正确的 LaTeX 语法（KaTeX 兼容）
- [ ] 块级公式 `$$...$$` 前后有空行
- [ ] 表格使用 markdown 表格语法
- [ ] 无遗漏页面

---

## 常见问题与解决方案

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| Agent "Prompt is too long" | PDF 页数太多，一次读取过多 | 分批 3-5 页读取和翻译 |
| 公式中 `_` 变成斜体 | markdown 库把 `_` 当 emphasis | `protect_math()` 先提取公式为占位符 |
| Git clone HTTPS 超时 | 网络问题 | 切换 SSH: `git@github.com:org/repo.git` |
| pip install 被 PEP 668 阻止 | macOS 系统 Python 保护 | 加 `--break-system-packages` |
| KaTeX 公式未渲染 | CDN 未加载完 | 增加 `wait_for_timeout` 时间 |
| 翻译页面溢出对齐错误 | 整体渲染导致页码偏移 | 每页单独渲染 PDF 再合并 |

---

## 并行优化策略

| 可并行的任务 | 说明 |
|-------------|------|
| 精炼版撰写 vs 逐行翻译 | 精炼版完成后可立即开始翻译 |
| 多页翻译 | 不同页码范围可并行（每批 3-5 页）|
| 代码分析 vs 论文翻译 | 代码探索和论文阅读可同时进行 |
| 多篇论文 | 不同论文的全流程可完全并行 |

**注意：** 大 PDF（>10MB）的翻译 agent 容易因上下文过长而失败，需要更小的批次（2-3 页）。
